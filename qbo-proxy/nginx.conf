map $http_x_forwarded_proto $origin_proto { default https; }

limit_req_zone $binary_remote_addr zone=cb:5m rate=10r/m;
limit_req_zone $binary_remote_addr zone=peek:5m rate=60r/m;

server {
  listen 80;
  server_name _;

  # PUBLIC: Intuit lands here (code+state)
  location /qbo/callback {
    limit_req zone=cb burst=10 nodelay;
    proxy_pass https://bridge.scrapfutures.com;
    proxy_set_header Host bridge.scrapfutures.com;
    proxy_set_header X-Forwarded-Proto $origin_proto;
    proxy_set_header X-Forwarded-For $remote_addr;
  }

  # PRIVATE: your harvester polls with secret header
  location /admin/qbo/peek {
    limit_req zone=peek burst=20 nodelay;

    # optional extra lock:
    # allow 12.34.56.78;  # your office/home IP
    # deny all;

    proxy_set_header X-Relay-Auth "$QBO_RELAY_AUTH";  # set via Fly secret
    proxy_pass https://bridge.scrapfutures.com;
    proxy_set_header Host bridge.scrapfutures.com;
    proxy_set_header X-Forwarded-Proto $origin_proto;
    proxy_set_header X-Forwarded-For $remote_addr;
  }

  location / { return 404; }
}
