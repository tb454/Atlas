<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Atlas Owner Portal</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body{background:#0b0f14;color:#e9eef5}
    .card{background:#111826;border:1px solid #243245}
    .mono{font-family:ui-monospace, SFMono-Regular, Menlo, monospace}
    .muted{color:#9fb1c6}
  </style>
</head>
<body class="py-4">
<div class="container" style="max-width: 1100px;">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <div>
      <h2 class="mb-0">Atlas Owner Portal</h2>
      <div class="muted" id="ownerName">Loading…</div>
    </div>
    <button class="btn btn-outline-danger btn-sm" onclick="logout()">Logout</button>
  </div>

  <div class="card p-4 mb-3">
    <h4>Onboarding Status</h4>
    <div id="onboarding"></div>
  </div>

  <div class="card p-4 mb-3">
    <h4>Your IP Assets</h4>
    <div id="assets"></div>
  </div>

  <div class="card p-4 mb-3">
    <h4>Your Documents</h4>
    <div id="docs"></div>
  </div>
</div>

<script>
async function api(path, opts={}){
  const r = await fetch(path, opts);
  const j = await r.json().catch(()=> ({}));
  if(!r.ok) throw new Error(j.detail || `HTTP ${r.status}`);
  return j;
}
async function logout(){
  await api("/api/auth/logout", {method:"POST"});
  window.location.href="/static/atlas-login.html";
}

async function init(){
  const me = await api("/api/auth/me");
  if(!me.email || me.role !== "owner"){
    window.location.href="/static/atlas-login.html";
    return;
  }

  const o = await api("/api/owner/me");
  document.getElementById("ownerName").textContent =
    `${o.owner.legal_name} • ${o.owner.email || ""}`;

  const ob = await api("/api/owner/onboarding");
  document.getElementById("onboarding").innerHTML = ob.submission ? `
    <div class="mono">Status: ${ob.submission.status}</div>
    <div class="mt-2">${ob.submission.notes ? `<b>Notes:</b> ${ob.submission.notes}` : ""}</div>
    <div class="mt-2"><b>Doc Versions:</b> <span class="mono">${JSON.stringify(ob.submission.doc_versions_json||{})}</span></div>
  ` : `<div class="muted">No onboarding record found.</div>`;

  const a = await api("/api/owner/assets");
  const rows = a.items || [];
  document.getElementById("assets").innerHTML = `
    <table class="table table-dark table-sm">
      <thead><tr><th>Title</th><th>Type</th><th>Reg No</th><th>Status</th></tr></thead>
      <tbody>${rows.map(x=>`
        <tr>
          <td>${x.title||""}</td>
          <td>${x.asset_type||""}</td>
          <td>${x.reg_no||""}</td>
          <td>${x.status||""}</td>
        </tr>
      `).join("")}</tbody>
    </table>
  `;

  const d = await api("/api/owner/docs");
  const docs = d.items || [];
  document.getElementById("docs").innerHTML = docs.length ? `
    <table class="table table-dark table-sm">
      <thead><tr><th>Date</th><th>Type</th><th>Version</th><th></th></tr></thead>
      <tbody>${docs.map(x=>`
        <tr>
          <td>${new Date(x.created_at).toLocaleString()}</td>
          <td>${x.doc_type}</td>
          <td class="mono">${x.doc_version || ""}</td>
          <td><a class="btn btn-outline-light btn-sm" href="/api/owner/docs/${x.id}/download">Download</a></td>
        </tr>
      `).join("")}</tbody>
    </table>
  ` : `<div class="muted">No documents yet. Once approved, your executed documents will appear here.</div>`;
}

init();
</script>
</body>
</html>

